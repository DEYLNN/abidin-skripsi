<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel - TajwidMaster</title>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />

    <!-- AdminLTE CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css"
    />

    <!-- Google Font: Source Sans Pro -->
    <link
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700"
      rel="stylesheet"
    />

    <!-- Supabase CDN -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>

    <!-- Environment related scripts -->
    <script src="https://cdn.jsdelivr.net/npm/dotenv@16.0.3/lib/main.min.js"></script>
    <script src="env-loader.js"></script>
    <script src="env.js"></script>

    <style>
      :root {
        --primary: #2e7d32;
        --dark: #1b5e20;
        --accent: #ffd54f;
        --light: #ffffff;
        --text: #333333;
        --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .brand-image {
        height: 33px;
        width: auto;
        margin-right: 0.5rem;
      }

      .content-wrapper {
        min-height: calc(100vh - 57px);
        background-color: #f4f6f9;
        padding: 20px;
      }

      .main-header {
        border-bottom: 1px solid #dee2e6;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .nav-item .nav-link.active {
        background-color: rgba(255, 255, 255, 0.1);
      }

      .main-sidebar {
        background: linear-gradient(135deg, var(--primary), var(--dark));
      }

      .brand-link {
        background: rgba(255, 255, 255, 0.1) !important;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
      }

      .brand-text {
        color: white !important;
        font-weight: 600 !important;
      }

      .nav-sidebar .nav-link {
        color: rgba(255, 255, 255, 0.8);
        border-radius: 8px;
        margin: 2px 8px 2px 8px;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
      }

      .nav-sidebar .nav-link:hover {
        background-color: rgba(255, 255, 255, 0.1);
        color: white;
        transform: translateX(5px);
        margin-right: 8px;
        padding-right: 1.25rem;
      }

      .nav-sidebar .nav-link.active {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        margin-right: 12px;
        padding-right: 1.5rem;
      }

      .content-header {
        background: white;
        border-bottom: 1px solid #dee2e6;
        padding: 1rem 0;
        margin-bottom: 2rem;
      }

      .content-header h1 {
        color: var(--primary);
        font-weight: 600;
        margin: 0;
      }

      .card {
        margin-bottom: 1rem;
        box-shadow: 0 0 1px rgba(0, 0, 0, 0.125), 0 1px 3px rgba(0, 0, 0, 0.2);
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--text);
        font-size: 0.95rem;
      }

      .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #fafafa;
      }

      .form-control:focus {
        outline: none;
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
      }

      .form-control[rows] {
        resize: vertical;
        min-height: 100px;
      }

      /* Button Styles */
      .btn {
        background: linear-gradient(135deg, var(--primary), var(--dark));
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-right: 0.5rem;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(46, 125, 50, 0.3);
        background: linear-gradient(135deg, var(--dark), var(--primary));
      }

      .btn-primary {
        background: linear-gradient(135deg, var(--primary), var(--dark));
      }

      .btn-secondary {
        background: linear-gradient(135deg, #6c757d, #495057);
      }

      .btn-secondary:hover {
        background: linear-gradient(135deg, #495057, #6c757d);
        box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
      }

      .btn-danger {
        background: linear-gradient(135deg, #dc3545, #c82333);
      }

      .btn-danger:hover {
        background: linear-gradient(135deg, #c82333, #dc3545);
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
      }

      .btn-sm {
        padding: 0.5rem 1rem;
        font-size: 0.875rem;
        text-transform: none;
        letter-spacing: normal;
        margin-right: 0;
      }

      /* Button container styles for soal cards */
      .card-header .d-flex.gap-5 {
        margin-left: auto;
      }

      .card-header .d-flex.gap-5 .btn:last-child {
        margin-right: 0;
      }

      /* Alert Styles */
      .alert {
        padding: 1rem 1.5rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        border: none;
        font-weight: 500;
      }

      .alert-success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }

      .alert-error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
      }

      /* Materi List Styles */
      .materi-list {
        max-height: 600px;
        overflow-y: auto;
        background: white;
        border-radius: 12px;
        box-shadow: var(--shadow);
        overflow: hidden;
      }

      .materi-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem;
        border-bottom: 1px solid #e9ecef;
        transition: all 0.3s ease;
      }

      .materi-item:hover {
        background: #f8f9fa;
        transform: translateX(5px);
      }

      .materi-item:last-child {
        border-bottom: none;
      }

      .materi-info h3 {
        color: var(--primary);
        margin-bottom: 0.5rem;
        font-weight: 600;
        font-size: 1.1rem;
      }

      .materi-info p {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 0.5rem;
      }

      .materi-info small {
        color: #adb5bd;
        font-size: 0.8rem;
      }

      .materi-actions {
        display: flex;
        gap: 0.75rem;
      }

      /* Dynamic Form Styles */
      .dynamic-form {
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
        background: #f8f9fa;
      }

      .dynamic-form .form-group {
        background: white;
        padding: 1.5rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
        border: 1px solid #dee2e6;
        position: relative;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .dynamic-form .form-group:last-child {
        margin-bottom: 0;
      }

      .dynamic-form .form-group label {
        font-weight: 600;
        color: var(--primary);
        margin-bottom: 0.75rem;
        display: block;
        font-size: 0.9rem;
      }

      .dynamic-form .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background: #fafafa;
      }

      .dynamic-form .form-control:focus {
        outline: none;
        border-color: var(--primary);
        background: white;
        box-shadow: 0 0 0 3px rgba(46, 125, 50, 0.1);
      }

      .dynamic-form .form-control[rows] {
        resize: vertical;
        min-height: 80px;
      }

      .remove-item-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 35px;
        height: 35px;
        cursor: pointer;
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(220, 53, 69, 0.3);
      }

      .remove-item-btn:hover {
        background: #c82333;
        transform: scale(1.1);
        box-shadow: 0 4px 10px rgba(220, 53, 69, 0.4);
      }

      .item-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid var(--accent);
      }

      .item-title {
        font-weight: 600;
        color: var(--primary);
        font-size: 1.1rem;
      }

      .tips-section {
        background: rgba(255, 213, 79, 0.1);
        border: 1px solid var(--accent);
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1.5rem;
      }

      .tips-section h5 {
        color: var(--dark);
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
        font-weight: 600;
      }

      .tips-section h5 i {
        margin-right: 0.5rem;
        color: var(--accent);
      }

      .count-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-left: 0.5rem;
      }

      .count-badge.success {
        background: #d4edda;
        color: #155724;
      }

      .count-badge.danger {
        background: #f8d7da;
        color: #721c24;
      }

      /* File Upload Styles */
      .file-upload-area {
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 2rem;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
        margin-bottom: 1rem;
      }

      .file-upload-area:hover {
        border-color: var(--primary);
        background: rgba(46, 125, 50, 0.05);
      }

      .file-upload-area i {
        font-size: 2rem;
        color: var(--primary);
        margin-bottom: 1rem;
      }

      .preview-container {
        margin-top: 1rem;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
      }

      .preview-container img {
        max-width: 200px;
        max-height: 150px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .preview-container audio {
        width: 100%;
        max-width: 300px;
        border-radius: 8px;
      }

      /* Loading Spinner */
      .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 0.5rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Login Form Styles */
      .login-wrapper {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, var(--primary), var(--dark));
        padding: 20px;
      }

      .login-box {
        width: 100%;
        max-width: 400px;
        text-align: center;
      }

      .login-logo {
        margin-bottom: 2rem;
        color: white;
      }

      .login-logo h2 {
        margin: 1rem 0 0.5rem 0;
        font-weight: 600;
        color: white;
      }

      .login-logo p {
        margin: 0;
        opacity: 0.9;
        font-size: 1.1rem;
      }

      .login-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
      }

      .login-card .card {
        border: none;
        box-shadow: none;
      }

      .login-card .card-body {
        padding: 2rem;
      }

      .btn-block {
        width: 100%;
        margin-top: 1rem;
      }

      /* Stats Grid */
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
      }

      .stat-card {
        background: white;
        padding: 1.5rem;
        border-radius: 12px;
        box-shadow: var(--shadow);
        text-align: center;
        border-left: 4px solid var(--primary);
      }

      .stat-card h3 {
        color: var(--primary);
        font-size: 2rem;
        margin-bottom: 0.5rem;
        font-weight: 700;
      }

      .stat-card p {
        color: #6c757d;
        margin: 0;
        font-weight: 500;
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .dynamic-form {
          padding: 1rem;
        }

        .dynamic-form .form-group {
          padding: 1rem;
        }

        .materi-item {
          flex-direction: column;
          align-items: flex-start;
          gap: 1rem;
        }

        .materi-actions {
          width: 100%;
          justify-content: flex-end;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body class="hold-transition sidebar-mini">
    <!-- Login Form -->
    <div id="loginContainer" style="display: none;">
      <div class="login-wrapper">
        <div class="login-box">
          <div class="login-logo">
            <img src="gambar/tazakka.png" alt="TajwidMaster Logo" class="brand-image" style="height: 60px; width: auto;">
            <h2>TajwidMaster</h2>
            <p>Admin Panel</p>
          </div>
          <div class="login-card">
            <div class="card">
              <div class="card-body">
                <h4 class="text-center mb-4">Login Admin</h4>
                <div id="loginAlert"></div>
                <form id="loginForm">
                  <div class="form-group">
                    <label for="loginEmail">Email</label>
                    <input type="email" class="form-control" id="loginEmail" required>
                  </div>
                  <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" class="form-control" id="loginPassword" required>
                  </div>
                  <button type="submit" class="btn btn-primary btn-block">
                    <span class="loading-spinner" id="loginSpinner" style="display: none;"></span>
                    Login
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Admin Interface -->
    <div id="adminInterface" style="display: none;">
      <div class="wrapper">
        <!-- Navbar -->
        <nav class="main-header navbar navbar-expand navbar-white navbar-light">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link" data-widget="pushmenu" href="#" role="button">
                <i class="fas fa-bars"></i>
              </a>
            </li>
          </ul>

          <ul class="navbar-nav ml-auto">
            <li class="nav-item">
              <span class="nav-link">
                <i class="fas fa-user"></i> 
                <span id="userEmail"></span>
              </span>
            </li>
            <li class="nav-item">
              <a href="#" class="nav-link" id="logoutButton">
                <i class="fas fa-sign-out-alt"></i> Logout
              </a>
            </li>
          </ul>
        </nav>

      <!-- Main Sidebar Container -->
      <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <!-- Brand Logo -->
        <a href="index.html" class="brand-link">
          <img
            src="gambar/tazakka.png"
            alt="TajwidMaster Logo"
            class="brand-image"
          />
          <span class="brand-text font-weight-light">TajwidMaster</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">
          <!-- Sidebar Menu -->
          <nav class="mt-2">
            <ul
              class="nav nav-pills nav-sidebar flex-column"
              data-widget="treeview"
              role="menu"
            >
              <li class="nav-item">
                <a href="#" class="nav-link active" id="dashboardLink">
                  <i class="nav-icon fas fa-tachometer-alt"></i>
                  <p>Dashboard</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link" id="materiLink">
                  <i class="nav-icon fas fa-book"></i>
                  <p>Manajemen Materi</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="#" class="nav-link" id="latihanLink">
                  <i class="nav-icon fas fa-book"></i>
                  <p>Manajemen Latihan</p>
                </a>
              </li>
            </ul>
          </nav>
        </div>
      </aside>

      <!-- Content Wrapper -->
      <div class="content-wrapper">
        <!-- Content Header -->
        <div class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1 class="m-0" id="page-title">Dashboard</h1>
              </div>
            </div>
          </div>
        </div>

        <!-- Main content -->
        <section class="content">
          <div class="container-fluid">
            <!-- Dashboard Content -->
            <div id="dashboard-content">
              <div class="row">
                <div class="col-12">
                  <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">Selamat Datang di TajwidMaster</h3>
                    </div>
                    <div class="card-body">
                      <p>
                        Pilih menu di sidebar untuk mengelola konten aplikasi.
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Stats Overview -->
              <div class="stats-grid">
                <div class="stat-card">
                  <h3 id="total-materi">0</h3>
                  <p>Total Materi</p>
                </div>
                <div class="stat-card">
                  <h3 id="materi-pemula">0</h3>
                  <p>Level Pemula</p>
                </div>
                <div class="stat-card">
                  <h3 id="materi-menengah">0</h3>
                  <p>Level Menengah</p>
                </div>
                <div class="stat-card">
                  <h3 id="materi-lanjutan">0</h3>
                  <p>Level Lanjutan</p>
                </div>
                <div class="stat-card">
                  <h3 id="total-latihan">0</h3>
                  <p>Total Latihan</p>
                </div>
                <div class="stat-card">
                  <h3 id="latihan-harian">0</h3>
                  <p>Latihan Harian</p>
                </div>
                <div class="stat-card">
                  <h3 id="latihan-mingguan">0</h3>
                  <p>Latihan Mingguan</p>
                </div>
                <div class="stat-card">
                  <h3 id="latihan-ujian">0</h3>
                  <p>Ujian</p>
                </div>
              </div>
            </div>

            <!-- Materi Management Content -->
            <div id="materi-content" style="display: none">
              <div id="alert-container"></div>

              <!-- Materi Content -->
              <div class="row">
                <!-- Main Content -->
                <div class="col-md-12">
                  <div class="card">
                    <div class="card-header d-flex align-items-center w-100">
                      <h3 class="card-title m-0 text-black">Daftar Materi</h3>

                      <!-- pakai ms-auto (BS5) ATAU ml-auto (BS4) -->
                      <button
                        type="button"
                        class="btn btn-success btn-sm ms-auto ml-auto"
                        id="openMateriBtn"
                        onclick="toggleMateriForm()"
                      >
                        <i class="fas fa-plus"></i>
                        <span class="d-none d-md-inline"
                          >Tambah Materi Baru</span
                        >
                        <span class="d-md-none">Tambah</span>
                      </button>
                    </div>

                    <div class="card-body">
                      <!-- Form Section (initially hidden) -->
                      <div id="materi-form-section" style="display: none">
                        <div class="card">
                          <div class="card-header">
                            <h4>
                              <i class="fas fa-book"></i> Form Tambah Materi
                            </h4>
                          </div>
                          <div class="card-body">
                            <form id="materi-form">
                              <input type="hidden" id="materi-id" />

                              <!-- Basic Info -->
                              <div class="form-group">
                                <label for="judul">Judul (Arab)</label>
                                <input
                                  type="text"
                                  id="judul"
                                  class="form-control"
                                  required
                                />
                              </div>

                              <div class="form-group">
                                <label for="judul_latin">Judul (Latin)</label>
                                <input
                                  type="text"
                                  id="judul_latin"
                                  class="form-control"
                                  required
                                />
                              </div>

                              <div class="form-group">
                                <label for="deskripsi">Deskripsi (Arab)</label>
                                <textarea
                                  id="deskripsi"
                                  class="form-control"
                                  rows="3"
                                  required
                                ></textarea>
                              </div>

                              <div class="form-group">
                                <label for="pengertian_awal"
                                  >Pengertian Awal (Arab)</label
                                >
                                <textarea
                                  id="pengertian_awal"
                                  class="form-control"
                                  rows="4"
                                  required
                                ></textarea>
                              </div>

                              <div class="row">
                                <div class="col-md-6">
                                  <div class="form-group">
                                    <label for="level">Level</label>
                                    <select
                                      id="level"
                                      class="form-control"
                                      required
                                    >
                                      <option value="Pemula">Pemula</option>
                                      <option value="Menengah">Menengah</option>
                                      <option value="Lanjutan">Lanjutan</option>
                                    </select>
                                  </div>
                                </div>
                                <div class="col-md-6">
                                  <div class="form-group">
                                    <label for="jumlah_hukum"
                                      >Jumlah Hukum</label
                                    >
                                    <input
                                      type="number"
                                      id="jumlah_hukum"
                                      class="form-control"
                                      min="1"
                                      max="10"
                                      value="5"
                                      required
                                    />
                                  </div>
                                </div>
                              </div>

                              <div class="form-group">
                                <label for="gambar_url">Upload Gambar</label>
                                <div
                                  class="file-upload-area"
                                  onclick="document.getElementById('gambar_file').click()"
                                >
                                  <i class="fas fa-cloud-upload-alt"></i>
                                  <p>Klik untuk memilih gambar</p>
                                  <small style="color: #666"
                                    >Format: JPG, PNG, GIF. Maksimal 5MB</small
                                  >
                                </div>
                                <input
                                  type="file"
                                  id="gambar_file"
                                  accept="image/*"
                                  style="display: none"
                                />
                                <div
                                  id="gambar_preview"
                                  class="preview-container"
                                  style="display: none"
                                >
                                  <img id="preview_image" />
                                </div>
                                <input type="hidden" id="gambar_url" />
                              </div>

                              <!-- Materi Inti Section -->
                              <div class="form-group">
                                <label>Materi Inti</label>
                                <div style="margin-bottom: 1rem">
                                  <button
                                    type="button"
                                    class="btn btn-primary btn-sm"
                                    onclick="generateMateriInti()"
                                  >
                                    <i class="fas fa-magic"></i> Generate
                                  </button>
                                  <button
                                    type="button"
                                    class="btn btn-secondary btn-sm"
                                    onclick="addMateriIntiItem()"
                                  >
                                    <i class="fas fa-plus"></i> Tambah
                                  </button>
                                  <span
                                    id="materi-inti-count"
                                    class="count-badge"
                                  ></span>
                                </div>

                                <div id="materi-inti-form" class="dynamic-form">
                                  <!-- Hukum items will be added here dynamically -->
                                </div>

                                <textarea
                                  id="materi_inti"
                                  name="materi_inti"
                                  style="display: none"
                                  required
                                ></textarea>
                              </div>

                              <!-- Latihan Praktis Section -->
                              <div class="form-group">
                                <label>Latihan Praktis</label>
                                <div style="margin-bottom: 1rem">
                                  <button
                                    type="button"
                                    class="btn btn-secondary btn-sm"
                                    onclick="addLatihanPraktisItem()"
                                  >
                                    <i class="fas fa-plus"></i> Tambah Latihan
                                  </button>
                                  <span
                                    id="latihan-praktis-count"
                                    class="count-badge"
                                  ></span>
                                </div>

                                <div
                                  id="latihan-praktis-form"
                                  class="dynamic-form"
                                >
                                  <!-- Latihan items will be added here dynamically -->
                                </div>

                                <textarea
                                  id="latihan_praktis"
                                  name="latihan_praktis"
                                  style="display: none"
                                  required
                                ></textarea>
                              </div>

                              <div class="form-group">
                                <button
                                  type="submit"
                                  class="btn btn-primary"
                                  id="submit-btn"
                                >
                                  <i class="fas fa-save"></i> Tambah Materi
                                </button>
                                <button
                                  type="button"
                                  class="btn btn-secondary"
                                  id="cancel-btn"
                                  onclick="toggleMateriForm()"
                                  style="display: none"
                                >
                                  <i class="fas fa-times"></i> Batal
                                </button>
                              </div>
                            </form>
                          </div>
                        </div>
                      </div>

                      <!-- List Section -->
                      <div id="materi-list-section">
                        <div id="materi-list" class="materi-list">
                          <div
                            style="
                              text-align: center;
                              padding: 2rem;
                              color: #6c757d;
                            "
                          >
                            <i
                              class="fas fa-spinner fa-spin"
                              style="font-size: 2rem; margin-bottom: 1rem"
                            ></i>
                            <p>Loading...</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Latihan Management Content -->
            <div id="latihan-content" style="display: none">
              <div class="row">
                <div class="col-12">
                  <div class="card">
                    <div class="card-header">
                      <h3 class="card-title">Manajemen Latihan</h3>
                    </div>
                    <div class="card-body">
                      <!-- Category Tabs -->
                      <ul class="nav nav-tabs" id="latihanTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                          <a
                            class="nav-link active"
                            id="harian-tab"
                            data-toggle="tab"
                            href="#harian-content"
                            role="tab"
                            aria-controls="harian-content"
                            aria-selected="true"
                          >
                            <i class="fas fa-calendar-day"></i> Latihan Harian
                          </a>
                        </li>
                        <li class="nav-item" role="presentation">
                          <a
                            class="nav-link"
                            id="mingguan-tab"
                            data-toggle="tab"
                            href="#mingguan-content"
                            role="tab"
                            aria-controls="mingguan-content"
                            aria-selected="false"
                          >
                            <i class="fas fa-calendar-week"></i> Latihan
                            Mingguan
                          </a>
                        </li>
                        <li class="nav-item" role="presentation">
                          <a
                            class="nav-link"
                            id="ujian-tab"
                            data-toggle="tab"
                            href="#ujian-content"
                            role="tab"
                            aria-controls="ujian-content"
                            aria-selected="false"
                          >
                            <i class="fas fa-graduation-cap"></i> Ujian
                          </a>
                        </li>
                      </ul>

                      <!-- Tab Content -->
                      <div class="tab-content" id="latihanTabContent">
                        <!-- Harian Content -->
                        <div
                          class="tab-pane fade show active"
                          id="harian-content"
                          role="tabpanel"
                          aria-labelledby="harian-tab"
                        >
                          <div class="row mt-3">
                            <div class="col-12">
                              <div class="card">
                                <div class="card-header">
                                  <h5 class="card-title">Latihan Harian</h5>
                                  <div class="card-tools">
                                    <button
                                      type="button"
                                      class="btn btn-success btn-sm"
                                      onclick="addSoal('harian')"
                                    >
                                      <i class="fas fa-plus"></i> Tambah Soal
                                    </button>
                                  </div>
                                </div>
                                <div class="card-body">
                                  <div id="harian-soal-list">
                                    <!-- Soal list will be populated here -->
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Mingguan Content -->
                        <div
                          class="tab-pane fade"
                          id="mingguan-content"
                          role="tabpanel"
                          aria-labelledby="mingguan-tab"
                        >
                          <div class="row mt-3">
                            <div class="col-12">
                              <div class="card">
                                <div class="card-header">
                                  <h5 class="card-title">Latihan Mingguan</h5>
                                  <div class="card-tools">
                                    <button
                                      type="button"
                                      class="btn btn-success btn-sm"
                                      onclick="addSoal('mingguan')"
                                    >
                                      <i class="fas fa-plus"></i> Tambah Soal
                                    </button>
                                  </div>
                                </div>
                                <div class="card-body">
                                  <div id="mingguan-soal-list">
                                    <!-- Soal list will be populated here -->
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Ujian Content -->
                        <div
                          class="tab-pane fade"
                          id="ujian-content"
                          role="tabpanel"
                          aria-labelledby="ujian-tab"
                        >
                          <div class="row mt-3">
                            <div class="col-12">
                              <div class="card">
                                <div class="card-header">
                                  <h5 class="card-title">Ujian</h5>
                                  <div class="card-tools">
                                    <button
                                      type="button"
                                      class="btn btn-success btn-sm"
                                      onclick="addSoal('ujian')"
                                    >
                                      <i class="fas fa-plus"></i> Tambah Soal
                                    </button>
                                  </div>
                                </div>
                                <div class="card-body">
                                  <div id="ujian-soal-list">
                                    <!-- Soal list will be populated here -->
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Add Soal Modal -->
              <div
                class="modal fade"
                id="addSoalModal"
                tabindex="-1"
                role="dialog"
                aria-labelledby="addSoalModalLabel"
                aria-hidden="true"
              >
                <div class="modal-dialog modal-xl" role="document">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="addSoalModalLabel">
                        Tambah Soal Baru
                      </h5>
                      <button
                        type="button"
                        class="close"
                        data-dismiss="modal"
                        aria-label="Close"
                      >
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <form id="addSoalForm">
                        <input type="hidden" id="soalCategory" value="" />
                        <div class="form-group">
                          <label for="soalText">Pertanyaan</label>
                          <textarea
                            class="form-control"
                            id="soalText"
                            rows="3"
                            required
                          ></textarea>
                        </div>
                        <div class="form-group">
                          <label for="soalType">Tipe Soal</label>
                          <select class="form-control" id="soalType" required>
                            <option value="">Pilih Tipe</option>
                            <option value="pilihan_ganda">Pilihan Ganda</option>
                            <option value="essay">Essay</option>
                          </select>
                        </div>

                        <!-- Pilihan Ganda Options -->
                        <div id="pilihanGandaOptions" style="display: none">
                          <div class="form-group">
                            <label>Pilihan Jawaban</label>
                            <div class="row">
                              <div class="col-md-6">
                                <div class="input-group mb-2">
                                  <div class="input-group-prepend">
                                    <span class="input-group-text">A</span>
                                  </div>
                                  <input
                                    type="text"
                                    class="form-control"
                                    id="optionA"
                                    placeholder="Pilihan A"
                                  />
                                  <div class="input-group-append">
                                    <div class="input-group-text">
                                      <input
                                        type="radio"
                                        name="correctAnswer"
                                        value="A"
                                        id="correctA"
                                      />
                                    </div>
                                  </div>
                                </div>
                                <div class="input-group mb-2">
                                  <div class="input-group-prepend">
                                    <span class="input-group-text">B</span>
                                  </div>
                                  <input
                                    type="text"
                                    class="form-control"
                                    id="optionB"
                                    placeholder="Pilihan B"
                                  />
                                  <div class="input-group-append">
                                    <div class="input-group-text">
                                      <input
                                        type="radio"
                                        name="correctAnswer"
                                        value="B"
                                        id="correctB"
                                      />
                                    </div>
                                  </div>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="input-group mb-2">
                                  <div class="input-group-prepend">
                                    <span class="input-group-text">C</span>
                                  </div>
                                  <input
                                    type="text"
                                    class="form-control"
                                    id="optionC"
                                    placeholder="Pilihan C"
                                  />
                                  <div class="input-group-append">
                                    <div class="input-group-text">
                                      <input
                                        type="radio"
                                        name="correctAnswer"
                                        value="C"
                                        id="correctC"
                                      />
                                    </div>
                                  </div>
                                </div>
                                <div class="input-group mb-2">
                                  <div class="input-group-prepend">
                                    <span class="input-group-text">D</span>
                                  </div>
                                  <input
                                    type="text"
                                    class="form-control"
                                    id="optionD"
                                    placeholder="Pilihan D"
                                  />
                                  <div class="input-group-append">
                                    <div class="input-group-text">
                                      <input
                                        type="radio"
                                        name="correctAnswer"
                                        value="D"
                                        id="correctD"
                                      />
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Essay Options -->
                        <div id="essayOptions" style="display: none">
                          <div class="form-group">
                            <label for="correctEssayAnswer"
                              >Jawaban Benar</label
                            >
                            <textarea
                              class="form-control"
                              id="correctEssayAnswer"
                              rows="3"
                              placeholder="Masukkan jawaban yang benar (bisa multi-line)"
                            ></textarea>
                          </div>
                        </div>

                        <div class="form-group">
                          <label for="soalExplanation"
                            >Penjelasan (Opsional)</label
                          >
                          <textarea
                            class="form-control"
                            id="soalExplanation"
                            rows="2"
                            placeholder="Penjelasan mengapa jawaban ini benar"
                          ></textarea>
                        </div>
                      </form>
                    </div>
                    <div class="modal-footer">
                      <button
                        type="button"
                        class="btn btn-secondary"
                        data-dismiss="modal"
                      >
                        Batal
                      </button>
                      <button
                        type="button"
                        class="btn btn-primary"
                        onclick="saveSoal()"
                      >
                        Simpan Soal
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>
      </div>

      <!-- Footer -->
      <footer class="main-footer">
        <div class="float-right d-none d-sm-block"><b>Version</b> 1.0.0</div>
        <strong>Copyright &copy; 2025 <a href="#">TajwidMaster</a>.</strong> All
        rights reserved.
      </footer>
    </div>

    <!-- Required JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>

    <script>
      // Your existing JavaScript code here

      // Additional sidebar functionality
      document.addEventListener("DOMContentLoaded", async function () {
        // Attach form event listeners
        attachFormEventListeners();

        // Handle menu item clicks with routing
        const menuItems = document.querySelectorAll(".nav-sidebar .nav-link");
        menuItems.forEach((item) => {
          item.addEventListener("click", function (e) {
            e.preventDefault();

            // Remove active class from all menu items
            menuItems.forEach((i) => i.classList.remove("active"));
            this.classList.add("active");

            // Get the menu type from id
            const menuType = this.id;

            // Hide all content sections
            document.getElementById("dashboard-content").style.display = "none";
            document.getElementById("materi-content").style.display = "none";
            document.getElementById("latihan-content").style.display = "none";

            // Show the appropriate content based on menu type
            switch (menuType) {
              case "dashboardLink":
                document.getElementById("dashboard-content").style.display =
                  "block";
                document.getElementById("page-title").textContent = "Dashboard";
                // Update stats when dashboard is shown
                if (db) {
                  updateStats();
                }
                break;
              case "materiLink":
                document.getElementById("materi-content").style.display =
                  "block";
                document.getElementById("page-title").textContent =
                  "Manajemen Materi";
                // Load materi list when switching to materi page
                if (db) {
                  loadMateriList();
                }
                break;
              case "latihanLink":
                document.getElementById("latihan-content").style.display =
                  "block";
                document.getElementById("page-title").textContent =
                  "Manajemen Latihan";
                // Load soal list when switching to latihan page
                if (db) {
                  setTimeout(() => {
                    loadSoalList("harian");
                  }, 100);
                }
                break;
              default:
                document.getElementById("dashboard-content").style.display =
                  "block";
                document.getElementById("page-title").textContent = "Dashboard";
            }
          });
        });

        // Handle logout
        document
          .getElementById("logoutButton")
          .addEventListener("click", async function (e) {
            e.preventDefault();
            if (db && db.supabase) {
              const { error } = await db.supabase.auth.signOut();
              if (!error) {
                window.location.href = "index.html";
              }
            } else {
              window.location.href = "index.html";
            }
          });

        // Initialize Supabase and database
        const supabaseClient = await initializeSupabase();
        if (supabaseClient) {
          db = new AdminDatabase(supabaseClient);
          console.log("Admin database initialized successfully");

          // Load materi list only if database is initialized (but don't show it yet)
          // loadMateriList(); // Will be loaded when user clicks on materi menu

          // Add default items to forms (only if elements exist)
          const materiIntiForm = document.getElementById("materi-inti-form");
          const latihanPraktisForm = document.getElementById(
            "latihan-praktis-form"
          );
          const materiIntiTextarea = document.getElementById("materi_inti");
          const latihanPraktisTextarea =
            document.getElementById("latihan_praktis");
          const gambarFileInput = document.getElementById("gambar_file");

          if (materiIntiForm && materiIntiForm.children.length === 0) {
            addMateriIntiItem();
          }
          if (latihanPraktisForm && latihanPraktisForm.children.length === 0) {
            addLatihanPraktisItem();
          }

          // Set default values for hidden textareas
          if (materiIntiTextarea) {
            materiIntiTextarea.value = "[]";
          }
          if (latihanPraktisTextarea) {
            latihanPraktisTextarea.value = "[]";
          }

                  // Add file upload event listeners
        if (gambarFileInput) {
          gambarFileInput.addEventListener("change", function () {
            handleImageUpload(this);
          });
        }
        
        // Add event listener to update required attributes based on edit mode
        const materiForm = document.getElementById("materi-form");
        if (materiForm) {
          materiForm.addEventListener("input", function() {
            updateRequiredAttributes();
          });
        }

          // Load initial stats
          updateStats();
          
          // Initialize required attributes
          updateRequiredAttributes();
        } else {
          console.error("Failed to initialize Supabase client");
          showAlert(
            "Gagal menginisialisasi database. Silakan periksa konfigurasi.",
            "error"
          );
        }
      });

      // Wait for environment loader to be ready
      async function initializeSupabase() {
        console.log("Initializing Supabase...");

        // Wait for environment loader to be ready
        let timeout = 0;
        while (!window.envLoader || !window.envLoader.loaded) {
          console.log("Waiting for environment loader...");
          await new Promise((resolve) => setTimeout(resolve, 100));
          timeout += 100;
          if (timeout > 10000) {
            // 10 second timeout
            console.error("Timeout waiting for environment loader");
            return null;
          }
        }
        console.log("Environment loader ready");

        // Wait for Supabase to be loaded
        timeout = 0;
        while (!window.supabase) {
          console.log("Waiting for Supabase library...");
          await new Promise((resolve) => setTimeout(resolve, 100));
          timeout += 100;
          if (timeout > 10000) {
            // 10 second timeout
            console.error("Timeout waiting for Supabase library");
            return null;
          }
        }
        console.log("Supabase library loaded");

        // Supabase Configuration dari Environment Variables
        const SUPABASE_URL = getEnv("SUPABASE_URL");
        const SUPABASE_ANON_KEY = getEnv("SUPABASE_ANON_KEY");

        console.log("Environment variables:", {
          SUPABASE_URL: SUPABASE_URL ? "SET" : "NOT SET",
          SUPABASE_ANON_KEY: SUPABASE_ANON_KEY ? "SET" : "NOT SET",
        });

        // Validate environment variables
        if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
          console.error(
            "Environment variables tidak ditemukan. Pastikan file .env sudah ada dan berisi SUPABASE_URL dan SUPABASE_ANON_KEY."
          );
          return null;
        }

        try {
          // Initialize Supabase client
          const supabase = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_ANON_KEY
          );

          console.log("Supabase client initialized with environment variables");
          return supabase;
        } catch (error) {
          console.error("Error creating Supabase client:", error);
          return null;
        }
      }

      // Admin Database Class
      class AdminDatabase {
        constructor(supabaseClient) {
          this.supabase = supabaseClient;
        }

        async getAllMateri() {
          try {
            const { data, error } = await this.supabase
              .from("materi")
              .select("*")
              .order("created_at", { ascending: false });

            if (error) throw error;
            return data;
          } catch (error) {
            console.error("Error fetching materi:", error);
            return [];
          }
        }

        async addMateri(materiData) {
          try {
            const { data, error } = await this.supabase
              .from("materi")
              .insert([materiData])
              .select();

            if (error) throw error;
            return data[0];
          } catch (error) {
            console.error("Error adding materi:", error);
            throw error;
          }
        }

        async updateMateri(id, updateData) {
          try {
            const { data, error } = await this.supabase
              .from("materi")
              .update(updateData)
              .eq("id", id)
              .select();

            if (error) throw error;
            return data[0];
          } catch (error) {
            console.error("Error updating materi:", error);
            throw error;
          }
        }

        async deleteMateri(id) {
          try {
            const { error } = await this.supabase
              .from("materi")
              .delete()
              .eq("id", id);

            if (error) throw error;
            return true;
          } catch (error) {
            console.error("Error deleting materi:", error);
            throw error;
          }
        }

        // Soal Management Methods
        async getAllSoal(category = null) {
          try {
            let query = this.supabase
              .from("soal")
              .select("*")
              .order("created_at", { ascending: false });

            if (category) {
              query = query.eq("kategori", category);
            }

            const { data, error } = await query;
            if (error) throw error;
            return data;
          } catch (error) {
            console.error("Error fetching soal:", error);
            return [];
          }
        }

        async addSoal(soalData) {
          try {
            // Map the form data to database structure
            const mappedData = {
              kategori: soalData.category,
              pertanyaan: soalData.question,
              tipe_soal: soalData.type,
              jawaban_benar: soalData.correct_answer,
              pilihan_jawaban: soalData.options,
              penjelasan: soalData.explanation,
            };

            const { data, error } = await this.supabase
              .from("soal")
              .insert([mappedData])
              .select();

            if (error) throw error;
            return data[0];
          } catch (error) {
            console.error("Error adding soal:", error);
            throw error;
          }
        }

        async updateSoal(id, updateData) {
          try {
            // Map the form data to database structure
            const mappedData = {
              kategori: updateData.category,
              pertanyaan: updateData.question,
              tipe_soal: updateData.type,
              jawaban_benar: updateData.correct_answer,
              pilihan_jawaban: updateData.options,
              penjelasan: updateData.explanation,
              updated_at: new Date().toISOString(),
            };

            const { data, error } = await this.supabase
              .from("soal")
              .update(mappedData)
              .eq("id", id)
              .select();

            if (error) throw error;
            return data[0];
          } catch (error) {
            console.error("Error updating soal:", error);
            throw error;
          }
        }

        async deleteSoal(id) {
          try {
            const { error } = await this.supabase
              .from("soal")
              .delete()
              .eq("id", id);

            if (error) throw error;
            return true;
          } catch (error) {
            console.error("Error deleting soal:", error);
            throw error;
          }
        }
      }

      // Global variables
      let db = null;
      let isEditing = false;
      let currentEditId = null;
      let supabase = null;
      let currentUser = null;

      // Authentication functions
      function showLoginForm() {
        document.getElementById('loginContainer').style.display = 'block';
        document.getElementById('adminInterface').style.display = 'none';
      }

      function showAdminInterface() {
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('adminInterface').style.display = 'block';
      }

      function showLoginAlert(message, type = 'error') {
        const alertDiv = document.getElementById('loginAlert');
        alertDiv.innerHTML = `
          <div class="alert alert-${type === 'error' ? 'danger' : 'success'}">
            ${message}
          </div>
        `;
      }

      async function handleLogin(email, password) {
        try {
          const spinner = document.getElementById('loginSpinner');
          const loginBtn = document.querySelector('#loginForm button[type="submit"]');
          
          spinner.style.display = 'inline-block';
          loginBtn.disabled = true;

          const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password
          });

          if (error) {
            throw error;
          }

          // Save session to localStorage
          localStorage.setItem('adminSession', JSON.stringify(data.session));
          localStorage.setItem('adminUser', JSON.stringify(data.user));
          
          currentUser = data.user;
          document.getElementById('userEmail').textContent = currentUser.email;
          
          showAdminInterface();
          showLoginAlert('Login berhasil!', 'success');
          
          // Initialize the admin interface
          await initializeAdminInterface();
          
        } catch (error) {
          console.error('Login error:', error);
          showLoginAlert(error.message || 'Login gagal. Periksa email dan password Anda.');
        } finally {
          const spinner = document.getElementById('loginSpinner');
          const loginBtn = document.querySelector('#loginForm button[type="submit"]');
          spinner.style.display = 'none';
          loginBtn.disabled = false;
        }
      }

      async function handleLogout() {
        try {
          await supabase.auth.signOut();
          localStorage.removeItem('adminSession');
          localStorage.removeItem('adminUser');
          currentUser = null;
          showLoginForm();
        } catch (error) {
          console.error('Logout error:', error);
        }
      }

      async function checkAuthStatus() {
        try {
          // Check for existing session in localStorage
          const savedSession = localStorage.getItem('adminSession');
          const savedUser = localStorage.getItem('adminUser');
          
          if (savedSession && savedUser) {
            const session = JSON.parse(savedSession);
            const user = JSON.parse(savedUser);
            
            // Check if session is still valid
            const { data, error } = await supabase.auth.getSession();
            
            if (data.session && !error) {
              currentUser = user;
              document.getElementById('userEmail').textContent = currentUser.email;
              showAdminInterface();
              return true;
            } else {
              // Session expired, clear localStorage
              localStorage.removeItem('adminSession');
              localStorage.removeItem('adminUser');
            }
          }
          
          return false;
        } catch (error) {
          console.error('Auth check error:', error);
          return false;
        }
      }

      async function initializeAdminInterface() {
        // Initialize Supabase and database
        supabase = await initializeSupabase();
        if (supabase) {
          db = new AdminDatabase(supabase);
          updateStats();
        }
      }

      // UI Functions
      function showAlert(message, type = "success") {
        const alertContainer = document.getElementById("alert-container");
        const alert = document.createElement("div");
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alertContainer.appendChild(alert);

        setTimeout(() => {
          alert.remove();
        }, 3000);
      }

      function renderMateriList(materiList) {
        const container = document.getElementById("materi-list");

        if (materiList.length === 0) {
          container.innerHTML = "<p>Tidak ada materi</p>";
          return;
        }

        container.innerHTML = materiList
          .map((materi) => {
            // Count hukum and latihan
            let hukumCount = 0;
            let latihanCount = 0;

            try {
              if (materi.materi_inti) {
                const materiInti =
                  typeof materi.materi_inti === "string"
                    ? JSON.parse(materi.materi_inti)
                    : materi.materi_inti;
                hukumCount = Array.isArray(materiInti) ? materiInti.length : 0;
              }

              if (materi.latihan_praktis) {
                const latihanPraktis =
                  typeof materi.latihan_praktis === "string"
                    ? JSON.parse(materi.latihan_praktis)
                    : materi.latihan_praktis;
                latihanCount = Array.isArray(latihanPraktis)
                  ? latihanPraktis.length
                  : 0;
              }
            } catch (error) {
              console.error(
                "Error counting items for materi:",
                materi.id,
                error
              );
            }

            return `
                <div class="materi-item">
                    <div class="materi-info">
                        <h3>${materi.judul}</h3>
                        <p>${materi.judul_latin}  ${materi.level}  ${
              materi.jumlah_hukum || 0
            } hukum  ${latihanCount} latihan</p>
                        <small style="color: #999;">
                          ${
                            materi.pengertian_awal
                              ? " Pengertian awal"
                              : " Pengertian awal"
                          } 
                          ${
                            hukumCount > 0 ? " Materi inti" : " Materi inti"
                          } 
                          ${
                            latihanCount > 0
                              ? " Latihan praktis"
                              : " Latihan praktis"
                          }
                        </small>
                    </div>
                    <div class="materi-actions">
                        <button class="btn btn-sm" onclick="editMateri('${
                          materi.id
                        }')">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                    </div>
                </div>
              `;
          })
          .join("");
      }

      function loadMateriList() {
        if (!db) {
          console.error("Database not initialized");
          showAlert("Database belum diinisialisasi", "error");
          return;
        }

        db.getAllMateri()
          .then((materiList) => {
            renderMateriList(materiList);
            updateStats(); // Update stats after loading list
          })
          .catch((error) => {
            showAlert("Error loading materi: " + error.message, "error");
          });
      }

      function resetForm() {
        // Reset the form
        document.getElementById("materi-form").reset();
        
        // Clear hidden fields
        document.getElementById("materi-id").value = "";
        document.getElementById("gambar_url").value = "";
        
        // Reset button states
        document.getElementById("submit-btn").textContent = "Tambah Materi";
        document.getElementById("cancel-btn").style.display = "none";
        
        // Reset editing state
        isEditing = false;
        currentEditId = null;

        // Clear image preview
        const preview = document.getElementById("gambar_preview");
        if (preview) {
          preview.style.display = "none";
        }

        // Clear dynamic forms
        const materiIntiForm = document.getElementById("materi-inti-form");
        const latihanPraktisForm = document.getElementById(
          "latihan-praktis-form"
        );

        if (materiIntiForm) {
          materiIntiForm.innerHTML = "";
        }
        if (latihanPraktisForm) {
          latihanPraktisForm.innerHTML = "";
        }

        // Update counts
        updateMateriIntiCount();
        updateLatihanPraktisCount();

        // Set default values for hidden textareas
        const materiIntiTextarea = document.getElementById("materi_inti");
        const latihanPraktisTextarea =
          document.getElementById("latihan_praktis");

        if (materiIntiTextarea) {
          materiIntiTextarea.value = "[]";
        }
        if (latihanPraktisTextarea) {
          latihanPraktisTextarea.value = "[]";
        }
        
        // Reset editing state
        isEditing = false;
        currentEditId = null;
        
        // Update required attributes for add mode
        updateRequiredAttributes();
      }

      function editMateri(id) {
        // Find materi by id and populate form
        db.getAllMateri().then((materiList) => {
          const materi = materiList.find((m) => m.id === id);
          if (materi) {
                                  // Set editing state
            isEditing = true;
            currentEditId = id;
            
            // Clear form first
            document.getElementById("materi-form").reset();
            document.getElementById("materi-id").value = "";
            document.getElementById("gambar_url").value = "";
            
            // Clear image preview
            const preview = document.getElementById("gambar_preview");
            if (preview) {
              preview.style.display = "none";
            }
            
            // Clear dynamic forms
            document.getElementById("materi-inti-form").innerHTML = "";
            document.getElementById("latihan-praktis-form").innerHTML = "";
            
            // Populate form fields
            document.getElementById("materi-id").value = materi.id;
            document.getElementById("judul").value = materi.judul;
            document.getElementById("judul_latin").value =
              materi.judul_latin || "";
            document.getElementById("deskripsi").value = materi.deskripsi;
            document.getElementById("pengertian_awal").value =
              materi.pengertian_awal || "";
            document.getElementById("level").value = materi.level;
            document.getElementById("gambar_url").value = materi.gambar_url || "";
            document.getElementById("jumlah_hukum").value =
              materi.jumlah_hukum || 5;

            // Show existing image if available
            if (materi.gambar_url && materi.gambar_url.trim() !== "") {
              const preview = document.getElementById("gambar_preview");
              const previewImg = document.getElementById("preview_image");
              if (preview && previewImg) {
                previewImg.src = materi.gambar_url;
                preview.style.display = "block";
              }
            }



            // Handle Materi Inti
            if (materi.materi_inti) {
              try {
                const materiInti =
                  typeof materi.materi_inti === "string"
                    ? JSON.parse(materi.materi_inti)
                    : materi.materi_inti;

                if (Array.isArray(materiInti)) {
                  materiInti.forEach((item) => {
                    addMateriIntiFormItem(item);
                  });
                }
              } catch (error) {
                console.error("Error parsing materi_inti:", error);
              }
            }

            // Handle Latihan Praktis
            if (materi.latihan_praktis) {
              try {
                const latihanPraktis =
                  typeof materi.latihan_praktis === "string"
                    ? JSON.parse(materi.latihan_praktis)
                    : materi.latihan_praktis;

                if (Array.isArray(latihanPraktis)) {
                  latihanPraktis.forEach((item) => {
                    addLatihanPraktisFormItem(item);
                  });
                }
              } catch (error) {
                console.error("Error parsing latihan_praktis:", error);
              }
            }
            
            // Update counts
            updateMateriIntiCount();
            updateLatihanPraktisCount();

            // Update button text and show cancel button
            document.getElementById("submit-btn").textContent = "Update Materi";
            document.getElementById("cancel-btn").style.display = "inline-block";
            
            // Show form section first
            toggleMateriForm();
            
            // Update audio previews and required attributes after form is shown
            setTimeout(() => {
              updateAudioPreviews();
              updateRequiredAttributes();
            }, 100);
          }
        });
      }

      async function deleteMateri(id) {
        if (confirm("Apakah Anda yakin ingin menghapus materi ini?")) {
          try {
            await db.deleteMateri(id);
            showAlert("Materi berhasil dihapus");
            loadMateriList();
            updateStats(); // Update dashboard stats
          } catch (error) {
            showAlert("Error deleting materi: " + error.message, "error");
          }
        }
      }

      // Event Listeners - These will be attached after sidebar is loaded
      function attachFormEventListeners() {
        const materiForm = document.getElementById("materi-form");
        const cancelBtn = document.getElementById("cancel-btn");
        const materiIntiForm = document.getElementById("materi-inti-form");
        const latihanPraktisForm = document.getElementById(
          "latihan-praktis-form"
        );

        if (materiForm) {
          materiForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            // Use the new file upload submission function
            await submitFormWithFiles();
          });
        }

        if (cancelBtn) {
          cancelBtn.addEventListener("click", function() {
            if (isEditing) {
              // If editing, just close form
              toggleMateriForm();
            } else {
              // If adding new, reset form
              resetForm();
            }
          });
        }

        // Add real-time count updates
        if (materiIntiForm) {
          materiIntiForm.addEventListener("input", function () {
            updateMateriIntiCount();
          });
        }

        if (latihanPraktisForm) {
          latihanPraktisForm.addEventListener("input", function () {
            updateLatihanPraktisCount();
          });
        }
      }

      // Materi Inti Management Functions
      function generateMateriInti() {
        const jumlahHukum =
          parseInt(document.getElementById("jumlah_hukum").value) || 5;
        const judulLatin =
          document.getElementById("judul_latin").value || "Materi";

        // Clear existing form
        const formContainer = document.getElementById("materi-inti-form");
        formContainer.innerHTML = "";

        // Generate form items
        for (let i = 1; i <= jumlahHukum; i++) {
          addMateriIntiFormItem({
            id: i,
            judul: ` ${i}`,
            judul_latin: `Hukum ${i}`,
            deskripsi: `Penjelasan hukum ${i} dalam ${judulLatin}`,
            contoh_ayat: "",
            terjemahan: `Contoh hukum ${i} (QS. Al-Baqarah: 2)`,
            audio_url: `sound/hukum_${i}.opus`,
            tips: {
              judul: "",
              konten: " ",
            },
          });
        }

        updateMateriIntiCount();
        showAlert(
          `Generated ${jumlahHukum} hukum untuk materi inti`,
          "success"
        );
        
        // Update required attributes
        updateRequiredAttributes();
      }

      function addMateriIntiItem() {
        const formContainer = document.getElementById("materi-inti-form");
        const existingItems = formContainer.querySelectorAll(".form-group");
        const newId = existingItems.length + 1;

        addMateriIntiFormItem({
          id: newId,
          judul: ` ${newId}`,
          judul_latin: `Hukum ${newId}`,
          deskripsi: `Penjelasan hukum ${newId}`,
          contoh_ayat: "",
          terjemahan: `Contoh hukum ${newId} (QS. Al-Baqarah: 2)`,
          audio_url: `sound/hukum_${newId}.opus`,
          tips: {
            judul: "",
            konten: " ",
          },
        });

        updateMateriIntiCount();

        // Update hidden textarea with current data
        const materiIntiContainer = document.getElementById("materi-inti-form");
        const materiIntiGroups =
          materiIntiContainer.querySelectorAll(".form-group");
        const materiIntiArray = [];

        materiIntiGroups.forEach((group, index) => {
          const inputs = group.querySelectorAll("input, textarea");
          const item = { id: index + 1 };

          inputs.forEach((input) => {
            if (input.name === "tips_judul" || input.name === "tips_konten") {
              if (!item.tips) item.tips = {};
              if (input.name === "tips_judul") item.tips.judul = input.value;
              if (input.name === "tips_konten") item.tips.konten = input.value;
            } else {
              item[input.name] = input.value;
            }
          });

          materiIntiArray.push(item);
        });

        document.getElementById("materi_inti").value =
          JSON.stringify(materiIntiArray);
        showAlert("Hukum baru ditambahkan", "success");
        
        // Update required attributes
        updateRequiredAttributes();
      }

      function addMateriIntiFormItem(data = {}) {
        const formContainer = document.getElementById("materi-inti-form");
        const newFormGroup = document.createElement("div");
        newFormGroup.className = "form-group";
        newFormGroup.dataset.itemId = data.id || Date.now();

        newFormGroup.innerHTML = `
          <button type="button" class="remove-item-btn" onclick="removeMateriIntiItem(this)">
            <i class="fas fa-times"></i>
          </button>
          <div class="item-header">
            <span class="item-title">Hukum ${data.id || "Baru"}</span>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label>Judul (Arab)</label>
              <input type="text" class="form-control" name="judul" value="${
                data.judul || ""
              }" required>
            </div>
            <div>
              <label>Judul (Latin)</label>
              <input type="text" class="form-control" name="judul_latin" value="${
                data.judul_latin || ""
              }" required>
            </div>
          </div>

          <label>Deskripsi (Arab)</label>
          <textarea class="form-control" name="deskripsi" rows="3" required>${
            data.deskripsi || ""
          }</textarea>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label>Contoh Ayat (Arab)</label>
              <input type="text" class="form-control" name="contoh_ayat" value="${
                data.contoh_ayat || ""
              }" required>
            </div>
            <div>
              <label>Terjemahan</label>
              <input type="text" class="form-control" name="terjemahan" value="${
                data.terjemahan || ""
              }" required>
            </div>
          </div>

          <label>Upload Audio</label>
          <input type="file" class="form-control" name="audio_file" accept="audio/*" ${!data.audio_url ? 'required' : ''}>
          <small style="color: #666; display: block; margin-top: 5px;">
            Format: MP3, WAV, OGG. Maksimal 10MB
          </small>
          <div class="audio_preview" style="margin-top: 10px; display: ${
            data.audio_url ? 'block' : 'none'
          };">
            <audio controls style="width: 100%; max-width: 300px;">
              <source id="preview_audio" src="${data.audio_url || ''}" type="audio/mpeg">
              Browser tidak mendukung audio
            </audio>
          </div>
          <input type="hidden" name="audio_url" value="${
            data.audio_url || ""
          }" />

          <div class="tips-section">
            <h5><i class="fas fa-lightbulb"></i> Tips</h5>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
              <div>
                <label>Judul Tips</label>
                <input type="text" class="form-control" name="tips_judul" value="${
                  data.tips?.judul || ""
                }">
              </div>
              <div>
                <label>Konten Tips</label>
                <input type="text" class="form-control" name="tips_konten" value="${
                  data.tips?.konten || ""
                }">
              </div>
            </div>
          </div>
        `;

        formContainer.appendChild(newFormGroup);

        // Add event listener for audio file upload
        const audioFileInput = newFormGroup.querySelector(
          'input[name="audio_file"]'
        );
        if (audioFileInput) {
          audioFileInput.addEventListener("change", function () {
            handleAudioUpload(this);
          });
        }
        
        // Update required attributes after adding item
        updateRequiredAttributes();
      }

      function removeMateriIntiItem(button) {
        if (confirm("Apakah Anda yakin ingin menghapus hukum ini?")) {
          button.closest(".form-group").remove();
          updateMateriIntiCount();

          // Update hidden textarea with current data
          const materiIntiContainer =
            document.getElementById("materi-inti-form");
          const materiIntiGroups =
            materiIntiContainer.querySelectorAll(".form-group");
          const materiIntiArray = [];

          materiIntiGroups.forEach((group, index) => {
            const inputs = group.querySelectorAll("input, textarea");
            const item = { id: index + 1 };

            inputs.forEach((input) => {
              if (input.name === "tips_judul" || input.name === "tips_konten") {
                if (!item.tips) item.tips = {};
                if (input.name === "tips_judul") item.tips.judul = input.value;
                if (input.name === "tips_konten")
                  item.tips.konten = input.value;
              } else {
                item[input.name] = input.value;
              }
            });

            materiIntiArray.push(item);
          });

          document.getElementById("materi_inti").value =
            JSON.stringify(materiIntiArray);
          showAlert("Hukum berhasil dihapus", "success");
          
          // Update required attributes
          updateRequiredAttributes();
        }
      }

      function updateMateriIntiCount() {
        const formContainer = document.getElementById("materi-inti-form");
        const countSpan = document.getElementById("materi-inti-count");
        const formGroups = formContainer.querySelectorAll(".form-group");

        countSpan.textContent = `${formGroups.length} hukum`;
        countSpan.classList.remove("success", "danger");
        if (formGroups.length > 0) {
          countSpan.classList.add("success");
        } else {
          countSpan.classList.add("danger");
        }
      }

      // Convert form data to JSON
      function convertMateriIntiToJSON() {
        const formContainer = document.getElementById("materi-inti-form");
        const formGroups = formContainer.querySelectorAll(".form-group");
        const jsonArray = [];

        formGroups.forEach((group, index) => {
          const inputs = group.querySelectorAll("input, textarea");
          const item = {
            id: index + 1,
          };

          inputs.forEach((input) => {
            if (input.name === "tips_judul" || input.name === "tips_konten") {
              if (!item.tips) item.tips = {};
              if (input.name === "tips_judul") item.tips.judul = input.value;
              if (input.name === "tips_konten") item.tips.konten = input.value;
            } else {
              item[input.name] = input.value;
            }
          });

          jsonArray.push(item);
        });

        return jsonArray;
      }

      // Latihan Praktis Management Functions
      function addLatihanPraktisItem() {
        const formContainer = document.getElementById("latihan-praktis-form");
        const existingItems = formContainer.querySelectorAll(".form-group");
        const newId = existingItems.length + 1;

        addLatihanPraktisFormItem({
          id: newId,
          judul: `Latihan ${newId}`,
          deskripsi: `Deskripsi latihan ${newId}`,
          contoh: "",
          terjemahan: `Contoh latihan ${newId} (QS. Al-Baqarah: 2)`,
          audio_url: `sound/latihan_${newId}.opus`,
          jawaban: `Jawaban latihan ${newId}`,
          penjelasan: `Penjelasan latihan ${newId}`,
        });

        updateLatihanPraktisCount();

        // Update hidden textarea with current data
        const latihanContainer = document.getElementById(
          "latihan-praktis-form"
        );
        const latihanGroups = latihanContainer.querySelectorAll(".form-group");
        const latihanArray = [];

        latihanGroups.forEach((group, index) => {
          const inputs = group.querySelectorAll("input, textarea");
          const item = { id: index + 1 };

          inputs.forEach((input) => {
            item[input.name] = input.value;
          });

          latihanArray.push(item);
        });

        document.getElementById("latihan_praktis").value =
          JSON.stringify(latihanArray);
        showAlert("Latihan baru ditambahkan", "success");
        
        // Update required attributes
        updateRequiredAttributes();
      }

      function addLatihanPraktisFormItem(data = {}) {
        const formContainer = document.getElementById("latihan-praktis-form");
        const newFormGroup = document.createElement("div");
        newFormGroup.className = "form-group";
        newFormGroup.dataset.itemId = data.id || Date.now();

        newFormGroup.innerHTML = `
          <button type="button" class="remove-item-btn" onclick="removeLatihanPraktisItem(this)">
            <i class="fas fa-times"></i>
          </button>
          <div class="item-header">
            <span class="item-title">Latihan ${data.id || "Baru"}</span>
          </div>

          <label>Judul Latihan</label>
          <input type="text" class="form-control" name="judul" value="${
            data.judul || ""
          }" required>

          <label>Deskripsi</label>
          <textarea class="form-control" name="deskripsi" rows="3" required>${
            data.deskripsi || ""
          }</textarea>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label>Contoh Ayat (Arab)</label>
              <input type="text" class="form-control" name="contoh" value="${
                data.contoh || ""
              }" required>
            </div>
            <div>
              <label>Terjemahan</label>
              <input type="text" class="form-control" name="terjemahan" value="${
                data.terjemahan || ""
              }" required>
            </div>
          </div>

          <label>Upload Audio</label>
          <input type="file" class="form-control" name="audio_file" accept="audio/*" ${!data.audio_url ? 'required' : ''}>
          <small style="color: #666; display: block; margin-top: 5px;">
            Format: MP3, WAV, OGG. Maksimal 10MB
          </small>
          <div class="audio_preview" style="margin-top: 10px; display: ${
            data.audio_url ? 'block' : 'none'
          };">
            <audio controls style="width: 100%; max-width: 300px;">
              <source id="preview_audio" src="${data.audio_url || ''}" type="audio/mpeg">
              Browser tidak mendukung audio
            </audio>
          </div>
          <input type="hidden" name="audio_url" value="${
            data.audio_url || ""
          }" />

          <label>Jawaban</label>
          <textarea class="form-control" name="jawaban" rows="3" required>${
            data.jawaban || ""
          }</textarea>

          <label>Penjelasan</label>
          <textarea class="form-control" name="penjelasan" rows="3">${
            data.penjelasan || ""
          }</textarea>
        `;

        formContainer.appendChild(newFormGroup);

        // Add event listener for audio file upload
        const audioFileInput = newFormGroup.querySelector(
          'input[name="audio_file"]'
        );
        if (audioFileInput) {
          audioFileInput.addEventListener("change", function () {
            handleAudioUpload(this);
          });
        }
        
        // Update required attributes after adding item
        updateRequiredAttributes();
      }

      function removeLatihanPraktisItem(button) {
        if (confirm("Apakah Anda yakin ingin menghapus latihan ini?")) {
          button.closest(".form-group").remove();
          updateLatihanPraktisCount();

          // Update hidden textarea with current data
          const latihanContainer = document.getElementById(
            "latihan-praktis-form"
          );
          const latihanGroups =
            latihanContainer.querySelectorAll(".form-group");
          const latihanArray = [];

          latihanGroups.forEach((group, index) => {
            const inputs = group.querySelectorAll("input, textarea");
            const item = { id: index + 1 };

            inputs.forEach((input) => {
              item[input.name] = input.value;
            });

            latihanArray.push(item);
          });

          document.getElementById("latihan_praktis").value =
            JSON.stringify(latihanArray);
          showAlert("Latihan berhasil dihapus", "success");
          
          // Update required attributes
          updateRequiredAttributes();
        }
      }

      function updateLatihanPraktisCount() {
        const formContainer = document.getElementById("latihan-praktis-form");
        const countSpan = document.getElementById("latihan-praktis-count");
        const formGroups = formContainer.querySelectorAll(".form-group");

        countSpan.textContent = `${formGroups.length} latihan`;
        countSpan.classList.remove("success", "danger");
        if (formGroups.length > 0) {
          countSpan.classList.add("success");
        } else {
          countSpan.classList.add("danger");
        }
      }

      // Convert form data to JSON
      function convertLatihanPraktisToJSON() {
        const formContainer = document.getElementById("latihan-praktis-form");
        const formGroups = formContainer.querySelectorAll(".form-group");
        const jsonArray = [];

        formGroups.forEach((group, index) => {
          const inputs = group.querySelectorAll("input, textarea");
          const item = {
            id: index + 1,
          };

          inputs.forEach((input) => {
            item[input.name] = input.value;
          });

          jsonArray.push(item);
        });

        return jsonArray;
      }

      // File Upload Handling Functions
      function handleImageUpload(input) {
        const file = input.files[0];
        if (!file) return;

        // Validate file size (5MB max)
        if (file.size > 5 * 1024 * 1024) {
          showAlert("Ukuran file terlalu besar. Maksimal 5MB.", "error");
          input.value = "";
          return;
        }

        // Validate file type
        if (!file.type.startsWith("image/")) {
          showAlert("File harus berupa gambar.", "error");
          input.value = "";
          return;
        }

        // Show preview
        const preview = document.getElementById("gambar_preview");
        const previewImg = document.getElementById("preview_image");
        const reader = new FileReader();

        reader.onload = function (e) {
          previewImg.src = e.target.result;
          preview.style.display = "block";
        };

        reader.readAsDataURL(file);

        // Generate filename for preview (actual URL will be set after upload)
        const timestamp = Date.now();
        const extension = file.name.split(".").pop();
        const filename = `gambar_${timestamp}.${extension}`;
        // URL will be updated after upload to Supabase Storage
        
        // Update required attributes
        updateRequiredAttributes();
      }

      function handleAudioUpload(input) {
        const file = input.files[0];
        if (!file) return;

        // Validate file size (10MB max)
        if (file.size > 10 * 1024 * 1024) {
          showAlert("Ukuran file terlalu besar. Maksimal 10MB.", "error");
          input.value = "";
          return;
        }

        // Validate file type
        if (!file.type.startsWith("audio/")) {
          showAlert("File harus berupa audio.", "error");
          input.value = "";
          return;
        }

        // Show preview
        const preview = input.parentElement.querySelector(".audio_preview");
        const audioElement = preview.querySelector("audio source");
        const reader = new FileReader();

        reader.onload = function (e) {
          audioElement.src = e.target.result;
          preview.style.display = "block";
        };

        reader.readAsDataURL(file);

        // Generate filename for preview (actual URL will be set after upload)
        const timestamp = Date.now();
        const extension = file.name.split(".").pop();
        const filename = `audio_${timestamp}.${extension}`;
        // URL will be updated after upload to Supabase Storage
        
        // Update required attributes
        updateRequiredAttributes();
      }

      // Enhanced form submission with file uploads
      async function submitFormWithFiles() {
        const form = document.getElementById("materi-form");
        const formData = new FormData();

        // Get main form data
        const mainInputs = form.querySelectorAll("input, textarea, select");
        mainInputs.forEach((input) => {
          if (input.type === "file") {
            if (input.files[0]) {
              formData.append(input.id, input.files[0]);
            }
          } else {
            formData.append(input.id, input.value);
          }
        });

        // Get dynamic form data
        const materiIntiForm = document.getElementById("materi-inti-form");
        const latihanPraktisForm = document.getElementById(
          "latihan-praktis-form"
        );

        // Process materi inti files
        const materiIntiItems = materiIntiForm.querySelectorAll(".form-group");
        const materiIntiData = [];

        materiIntiItems.forEach((item, index) => {
          const itemData = { id: index + 1 };
          const inputs = item.querySelectorAll("input, textarea");

          inputs.forEach((input) => {
            if (input.type === "file" && input.files[0]) {
              const timestamp = Date.now() + index;
              const extension = input.files[0].name.split(".").pop();
              const filename = `audio_${timestamp}.${extension}`;
              formData.append(`materi_inti_audio_${index}`, input.files[0]);
              itemData[
                input.name.replace("_file", "_url")
              ] = `sound/${filename}`;
            } else if (input.type !== "file") {
              if (input.name === "tips_judul" || input.name === "tips_konten") {
                if (!itemData.tips) itemData.tips = {};
                if (input.name === "tips_judul")
                  itemData.tips.judul = input.value;
                if (input.name === "tips_konten")
                  itemData.tips.konten = input.value;
              } else {
                itemData[input.name] = input.value;
              }
            }
          });

          materiIntiData.push(itemData);
        });

        // Process latihan praktis files
        const latihanPraktisItems =
          latihanPraktisForm.querySelectorAll(".form-group");
        const latihanPraktisData = [];

        latihanPraktisItems.forEach((item, index) => {
          const itemData = { id: index + 1 };
          const inputs = item.querySelectorAll("input, textarea");

          inputs.forEach((input) => {
            if (input.type === "file" && input.files[0]) {
              const timestamp = Date.now() + index + 1000;
              const extension = input.files[0].name.split(".").pop();
              const filename = `audio_${timestamp}.${extension}`;
              formData.append(`latihan_audio_${index}`, input.files[0]);
              itemData[
                input.name.replace("_file", "_url")
              ] = `sound/${filename}`;
            } else if (input.type !== "file") {
              itemData[input.name] = input.value;
            }
          });

          latihanPraktisData.push(itemData);
        });

        // Add JSON data to form and update hidden textareas
        const materiIntiJson = JSON.stringify(materiIntiData);
        const latihanPraktisJson = JSON.stringify(latihanPraktisData);

        formData.append("materi_inti", materiIntiJson);
        formData.append("latihan_praktis", latihanPraktisJson);

        // Update hidden textareas
        document.getElementById("materi_inti").value = materiIntiJson;
        document.getElementById("latihan_praktis").value = latihanPraktisJson;

        try {
          // Upload files first
          const uploadedFiles = await uploadFiles(formData);

          // Update URLs with Supabase Storage URLs
          let gambarUrl = formData.get("gambar_url");
          const materiIntiData = JSON.parse(formData.get("materi_inti"));
          const latihanPraktisData = JSON.parse(
            formData.get("latihan_praktis")
          );

          // Update main image URL
          const imageFile = uploadedFiles.find(
            (f) => f.field === "gambar_file"
          );
          if (imageFile && imageFile.filename !== 'existing') {
            gambarUrl = imageFile.url;
          }

          // Update audio URLs in materi inti
          materiIntiData.forEach((item, index) => {
            const audioFile = uploadedFiles.find(
              (f) => f.field === `materi_inti_audio_${index}`
            );
            if (audioFile && audioFile.filename !== 'existing') {
              item.audio_url = audioFile.url;
            }
          });

          // Update audio URLs in latihan praktis
          latihanPraktisData.forEach((item, index) => {
            const audioFile = uploadedFiles.find(
              (f) => f.field === `latihan_audio_${index}`
            );
            if (audioFile && audioFile.filename !== 'existing') {
              item.audio_url = audioFile.url;
            }
          });

          // Then save to database
          const materiData = {
            judul: formData.get("judul"),
            judul_latin: formData.get("judul_latin"),
            deskripsi: formData.get("deskripsi"),
            pengertian_awal: formData.get("pengertian_awal"),
            level: formData.get("level"),
            gambar_url: gambarUrl,
            jumlah_hukum: parseInt(formData.get("jumlah_hukum")),
            materi_inti: JSON.stringify(materiIntiData),
            latihan_praktis: JSON.stringify(latihanPraktisData),
          };

          if (currentEditId) {
            await db.updateMateri(currentEditId, materiData);
            showAlert("Materi berhasil diperbarui!", "success");
          } else {
            await db.addMateri(materiData);
            showAlert("Materi berhasil ditambahkan!", "success");
          }

          // Reset form and close it
          resetForm();
          loadMateriList();
          updateStats(); // Update dashboard stats
          toggleMateriForm(); // Close form after successful submission
        } catch (error) {
          console.error("Error submitting form:", error);
          showAlert("Terjadi kesalahan saat menyimpan materi.", "error");
        }
      }

      async function uploadFiles(formData) {
        try {
          const uploadedFiles = [];

          // Upload main image file
          const imageFile = document.getElementById("gambar_file").files[0];
          const existingImageUrl = document.getElementById("gambar_url").value;
          
          if (imageFile) {
            const timestamp = Date.now();
            const extension = imageFile.name.split(".").pop();
            const filename = `gambar_${timestamp}.${extension}`;

            const { data: imageData, error: imageError } =
              await db.supabase.storage
                .from("abidin")
                .upload(`gambar/${filename}`, imageFile, {
                  cacheControl: "3600",
                  upsert: false,
                });

            if (imageError) throw imageError;

            const { data: imageUrl } = db.supabase.storage
              .from("abidin")
              .getPublicUrl(`gambar/${filename}`);

            uploadedFiles.push({
              field: "gambar_file",
              filename: filename,
              url: imageUrl.publicUrl,
            });
          } else if (existingImageUrl) {
            // Keep existing image URL if no new file is uploaded
            uploadedFiles.push({
              field: "gambar_file",
              filename: 'existing',
              url: existingImageUrl,
            });
          }

          // Upload audio files from materi inti
          const materiIntiForm = document.getElementById("materi-inti-form");
          const materiIntiItems =
            materiIntiForm.querySelectorAll(".form-group");

          for (let i = 0; i < materiIntiItems.length; i++) {
            const audioFile = materiIntiItems[i].querySelector(
              'input[name="audio_file"]'
            ).files[0];
            const existingAudioUrl = materiIntiItems[i].querySelector(
              'input[name="audio_url"]'
            ).value;
            
            if (audioFile) {
              const timestamp = Date.now() + i;
              const extension = audioFile.name.split(".").pop();
              const filename = `audio_${timestamp}.${extension}`;

              const { data: audioData, error: audioError } =
                await db.supabase.storage
                  .from("abidin")
                  .upload(`sound/${filename}`, audioFile, {
                    cacheControl: "3600",
                    upsert: false,
                  });

              if (audioError) throw audioError;

              const { data: audioUrl } = db.supabase.storage
                .from("abidin")
                .getPublicUrl(`sound/${filename}`);

              uploadedFiles.push({
                field: `materi_inti_audio_${i}`,
                filename: filename,
                url: audioUrl.publicUrl,
              });
            } else if (existingAudioUrl) {
              // Keep existing audio URL if no new file is uploaded
              uploadedFiles.push({
                field: `materi_inti_audio_${i}`,
                filename: 'existing',
                url: existingAudioUrl,
              });
            }
          }

          // Upload audio files from latihan praktis
          const latihanPraktisForm = document.getElementById(
            "latihan-praktis-form"
          );
          const latihanPraktisItems =
            latihanPraktisForm.querySelectorAll(".form-group");

          for (let i = 0; i < latihanPraktisItems.length; i++) {
            const audioFile = latihanPraktisItems[i].querySelector(
              'input[name="audio_file"]'
            ).files[0];
            const existingAudioUrl = latihanPraktisItems[i].querySelector(
              'input[name="audio_url"]'
            ).value;
            
            if (audioFile) {
              const timestamp = Date.now() + i + 1000;
              const extension = audioFile.name.split(".").pop();
              const filename = `audio_${timestamp}.${extension}`;

              const { data: audioData, error: audioError } =
                await db.supabase.storage
                  .from("abidin")
                  .upload(`sound/${filename}`, audioFile, {
                    cacheControl: "3600",
                    upsert: false,
                  });

              if (audioError) throw audioError;

              const { data: audioUrl } = db.supabase.storage
                .from("abidin")
                .getPublicUrl(`sound/${filename}`);

              uploadedFiles.push({
                field: `latihan_audio_${i}`,
                filename: filename,
                url: audioUrl.publicUrl,
              });
            } else if (existingAudioUrl) {
              // Keep existing audio URL if no new file is uploaded
              uploadedFiles.push({
                field: `latihan_audio_${i}`,
                filename: 'existing',
                url: existingAudioUrl,
              });
            }
          }

          console.log("Files uploaded successfully:", uploadedFiles);
          return uploadedFiles;
        } catch (error) {
          console.error("Error uploading files:", error);
          throw new Error(`Upload failed: ${error.message}`);
        }
      }

      // Function to update audio previews
      function updateAudioPreviews() {
        // Update materi inti audio previews
        const materiIntiItems = document.querySelectorAll("#materi-inti-form .form-group");
        materiIntiItems.forEach(item => {
          const audioUrl = item.querySelector('input[name="audio_url"]');
          const audioPreview = item.querySelector('.audio_preview');
          const audioSource = item.querySelector('.audio_preview audio source');
          
          if (audioUrl && audioUrl.value && audioPreview && audioSource) {
            audioSource.src = audioUrl.value;
            audioPreview.style.display = 'block';
          }
        });
        
        // Update latihan praktis audio previews
        const latihanItems = document.querySelectorAll("#latihan-praktis-form .form-group");
        latihanItems.forEach(item => {
          const audioUrl = item.querySelector('input[name="audio_url"]');
          const audioPreview = item.querySelector('.audio_preview');
          const audioSource = item.querySelector('.audio_preview audio source');
          
          if (audioUrl && audioUrl.value && audioPreview && audioSource) {
            audioSource.src = audioUrl.value;
            audioPreview.style.display = 'block';
          }
        });
      }

      // Function to update required attributes based on edit mode
      function updateRequiredAttributes() {
        const gambarFile = document.getElementById("gambar_file");
        const existingImageUrl = document.getElementById("gambar_url").value;
        
        // Set required for image only if not editing or no existing image
        if (gambarFile) {
          if (isEditing && existingImageUrl) {
            gambarFile.removeAttribute("required");
          } else {
            gambarFile.setAttribute("required", "");
          }
        }
        
        // Update audio file requirements in dynamic forms
        const materiIntiItems = document.querySelectorAll("#materi-inti-form .form-group");
        materiIntiItems.forEach(item => {
          const audioFile = item.querySelector('input[name="audio_file"]');
          const audioUrl = item.querySelector('input[name="audio_url"]');
          
          if (audioFile && audioUrl) {
            if (isEditing && audioUrl.value) {
              audioFile.removeAttribute("required");
            } else {
              audioFile.setAttribute("required", "");
            }
          }
        });
        
        const latihanItems = document.querySelectorAll("#latihan-praktis-form .form-group");
        latihanItems.forEach(item => {
          const audioFile = item.querySelector('input[name="audio_file"]');
          const audioUrl = item.querySelector('input[name="audio_url"]');
          
          if (audioFile && audioUrl) {
            if (isEditing && audioUrl.value) {
              audioFile.removeAttribute("required");
            } else {
              audioFile.setAttribute("required", "");
            }
          }
        });
      }

      // Function to update stats
      function updateStats() {
        const totalMateri = document.getElementById("total-materi");
        const materiPemula = document.getElementById("materi-pemula");
        const materiMenengah = document.getElementById("materi-menengah");
        const materiLanjutan = document.getElementById("materi-lanjutan");
        const totalLatihan = document.getElementById("total-latihan");
        const latihanHarian = document.getElementById("latihan-harian");
        const latihanMingguan = document.getElementById("latihan-mingguan");
        const latihanUjian = document.getElementById("latihan-ujian");

        // Update materi stats
        db.getAllMateri().then((materiList) => {
          totalMateri.textContent = materiList.length;
          materiPemula.textContent = materiList.filter(
            (m) => m.level === "Pemula"
          ).length;
          materiMenengah.textContent = materiList.filter(
            (m) => m.level === "Menengah"
          ).length;
          materiLanjutan.textContent = materiList.filter(
            (m) => m.level === "Lanjutan"
          ).length;
        });

        // Update latihan stats
        db.getAllSoal().then((soalList) => {
          totalLatihan.textContent = soalList.length;
          latihanHarian.textContent = soalList.filter(
            (s) => s.kategori === "harian"
          ).length;
          latihanMingguan.textContent = soalList.filter(
            (s) => s.kategori === "mingguan"
          ).length;
          latihanUjian.textContent = soalList.filter(
            (s) => s.kategori === "ujian"
          ).length;
        });
      }

      function toggleMateriForm() {
        const formSection = document.getElementById("materi-form-section");
        const listSection = document.getElementById("materi-list-section");
        const openBtn = document.getElementById("openMateriBtn");
        const cancelBtn = document.getElementById("cancel-btn");

        if (formSection.style.display === "none") {
          formSection.style.display = "block";
          listSection.style.display = "none";
          openBtn.innerHTML = '<i class="fas fa-times"></i> Tutup Form';
          openBtn.classList.remove("btn-primary");
          openBtn.classList.add("btn-danger");
          cancelBtn.style.display = "inline-block";
          
          // Update required attributes when opening form for add mode
          if (!isEditing) {
            updateRequiredAttributes();
          }
        } else {
          formSection.style.display = "none";
          listSection.style.display = "block";
          openBtn.innerHTML = '<i class="fas fa-plus"></i> Tambah Materi Baru';
          openBtn.classList.remove("btn-danger");
          openBtn.classList.add("btn-primary");
          cancelBtn.style.display = "none";
          
          // Only reset form if not in editing mode
          if (!isEditing) {
            resetForm();
          } else {
            // Reset editing state when closing form in edit mode
            isEditing = false;
            currentEditId = null;
          }
        }
      }

      // ===== LATIHAN MANAGEMENT FUNCTIONS =====

      // Show add soal form modal
      function addSoal(category) {
        document.getElementById("soalCategory").value = category;
        document.getElementById(
          "addSoalModalLabel"
        ).textContent = `Tambah Soal - ${getCategoryName(category)}`;
        $("#addSoalModal").modal("show");
      }

      // Get category display name
      function getCategoryName(category) {
        const names = {
          harian: "Latihan Harian",
          mingguan: "Latihan Mingguan",
          ujian: "Ujian",
        };
        return names[category] || category;
      }

      // Handle soal type change
      document.addEventListener("DOMContentLoaded", function () {
        const soalTypeSelect = document.getElementById("soalType");
        if (soalTypeSelect) {
          soalTypeSelect.addEventListener("change", function () {
            const selectedType = this.value;

            // Hide all option sections
            document.getElementById("pilihanGandaOptions").style.display =
              "none";
            document.getElementById("essayOptions").style.display = "none";

            // Show relevant section
            if (selectedType === "pilihan_ganda") {
              document.getElementById("pilihanGandaOptions").style.display =
                "block";
            } else if (selectedType === "essay") {
              document.getElementById("essayOptions").style.display = "block";
            }
          });
        }
      });

      // Save soal
      async function saveSoal() {
        // Check if database is initialized
        if (!db) {
          showAlert(
            "Database belum diinisialisasi. Silakan refresh halaman.",
            "error"
          );
          return;
        }

        const category = document.getElementById("soalCategory").value;
        const soalText = document.getElementById("soalText").value;
        const soalType = document.getElementById("soalType").value;
        const explanation = document.getElementById("soalExplanation").value;

        if (!soalText || !soalType) {
          showAlert("Pertanyaan dan tipe soal harus diisi!", "error");
          return;
        }

        let correctAnswer = "";
        let options = {};

        // Get correct answer based on soal type
        if (soalType === "pilihan_ganda") {
          const selectedAnswer = document.querySelector(
            'input[name="correctAnswer"]:checked'
          );
          if (!selectedAnswer) {
            showAlert("Pilih jawaban yang benar!", "error");
            return;
          }
          correctAnswer = selectedAnswer.value;

          // Get all options
          options = {
            A: document.getElementById("optionA").value,
            B: document.getElementById("optionB").value,
            C: document.getElementById("optionC").value,
            D: document.getElementById("optionD").value,
          };

          // Validate that all options are filled
          if (!options.A || !options.B || !options.C || !options.D) {
            showAlert("Semua pilihan jawaban harus diisi!", "error");
            return;
          }
        } else if (soalType === "essay") {
          correctAnswer = document.getElementById("correctEssayAnswer").value;
          if (!correctAnswer) {
            showAlert("Masukkan jawaban yang benar!", "error");
            return;
          }
        }

        try {
          const soalData = {
            category: category,
            question: soalText,
            type: soalType,
            correct_answer: correctAnswer,
            options: options,
            explanation: explanation,
            created_at: new Date().toISOString(),
          };

          // Save to database
          await db.addSoal(soalData);

          $("#addSoalModal").modal("hide");
          showAlert("Soal berhasil ditambahkan!", "success");

          // Reset form
          document.getElementById("addSoalForm").reset();
          document.getElementById("pilihanGandaOptions").style.display = "none";
          document.getElementById("essayOptions").style.display = "none";

          // Reload soal list
          loadSoalList(category);
          updateStats(); // Update dashboard stats
        } catch (error) {
          console.error("Error saving soal:", error);
          showAlert("Gagal menyimpan soal: " + error.message, "error");
        }
      }

      // Load soal list for a category
      async function loadSoalList(category) {
        const container = document.getElementById(`${category}-soal-list`);
        if (!container) return;

        // Check if database is initialized
        if (!db) {
          container.innerHTML = `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle"></i>
              Database belum diinisialisasi. Silakan refresh halaman.
            </div>
          `;
          return;
        }

        try {
          // Show loading
          container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: #6c757d;">
              <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
              <p>Loading soal...</p>
            </div>
          `;

          // Fetch soal from database
          const soalList = await db.getAllSoal(category);

          if (soalList.length === 0) {
            container.innerHTML = `
              <div class="alert alert-info">
                <i class="fas fa-info-circle"></i>
                Belum ada soal untuk ${getCategoryName(
                  category
                )}. Silakan tambah soal baru.
              </div>
            `;
            return;
          }

          // Render soal list
          container.innerHTML = soalList
            .map((soal, index) => {
              const optionsHtml =
                soal.tipe_soal === "pilihan_ganda" && soal.pilihan_jawaban
                  ? Object.entries(soal.pilihan_jawaban)
                      .map(
                        ([key, value]) =>
                          `<div class="mb-1">
                    <strong>${key}.</strong> ${value}
                    ${
                      key === soal.jawaban_benar
                        ? ' <i class="fas fa-check text-success"></i>'
                        : ""
                    }
                  </div>`
                      )
                      .join("")
                  : "";

              return `
              <div class="card mb-3">
                <div class="card-header d-flex justify-content-between  align-items-center">
                  <h6 class="mb-0">Soal #${index + 1}</h6>
                             <div class="d-flex gap-5">
             <button class="btn btn-sm btn-primary" onclick="editSoal('${
               soal.id
             }')">
               <i class="fas fa-edit"></i> Edit
             </button>
             <button class="btn btn-sm btn-danger" onclick="deleteSoal('${
               soal.id
             }', '${category}')">
               <i class="fas fa-trash"></i> Hapus
             </button>
           </div>
                </div>
                <div class="card-body">
                  <div class="mb-2">
                    <strong>Pertanyaan:</strong><br>
                    ${soal.pertanyaan}
                  </div>
                  <div class="mb-2">
                    <strong>Tipe:</strong> ${
                      soal.tipe_soal === "pilihan_ganda"
                        ? "Pilihan Ganda"
                        : "Essay"
                    }
                  </div>
                  ${
                    soal.tipe_soal === "pilihan_ganda"
                      ? `
                    <div class="mb-2">
                      <strong>Pilihan Jawaban:</strong><br>
                      ${optionsHtml}
                    </div>
                  `
                      : `
                    <div class="mb-2">
                      <strong>Jawaban Benar:</strong><br>
                      ${soal.jawaban_benar}
                    </div>
                  `
                  }
                  ${
                    soal.penjelasan
                      ? `
                    <div class="mb-2">
                      <strong>Penjelasan:</strong><br>
                      ${soal.penjelasan}
                    </div>
                  `
                      : ""
                  }
                  <small class="text-muted">
                    Dibuat: ${new Date(soal.created_at).toLocaleDateString(
                      "id-ID"
                    )}
                  </small>
                </div>
              </div>
            `;
            })
            .join("");
        } catch (error) {
          console.error("Error loading soal:", error);
          container.innerHTML = `
            <div class="alert alert-danger">
              <i class="fas fa-exclamation-triangle"></i>
              Gagal memuat soal: ${error.message}
            </div>
          `;
        }
      }

      // Edit soal
      async function editSoal(id) {
        // Check if database is initialized
        if (!db) {
          showAlert(
            "Database belum diinisialisasi. Silakan refresh halaman.",
            "error"
          );
          return;
        }

        try {
          const soalList = await db.getAllSoal();
          const soal = soalList.find((s) => s.id === id);

          if (!soal) {
            showAlert("Soal tidak ditemukan!", "error");
            return;
          }

          // Populate form with soal data
          document.getElementById("soalCategory").value = soal.kategori;
          document.getElementById("soalText").value = soal.pertanyaan;
          document.getElementById("soalType").value = soal.tipe_soal;
          document.getElementById("soalExplanation").value =
            soal.penjelasan || "";

          // Handle soal type change
          const soalTypeSelect = document.getElementById("soalType");
          soalTypeSelect.dispatchEvent(new Event("change"));

          // Populate options based on type
          if (soal.tipe_soal === "pilihan_ganda" && soal.pilihan_jawaban) {
            document.getElementById("optionA").value =
              soal.pilihan_jawaban.A || "";
            document.getElementById("optionB").value =
              soal.pilihan_jawaban.B || "";
            document.getElementById("optionC").value =
              soal.pilihan_jawaban.C || "";
            document.getElementById("optionD").value =
              soal.pilihan_jawaban.D || "";

            // Set correct answer
            const correctRadio = document.getElementById(
              `correct${soal.jawaban_benar}`
            );
            if (correctRadio) correctRadio.checked = true;
          } else if (soal.tipe_soal === "essay") {
            document.getElementById("correctEssayAnswer").value =
              soal.jawaban_benar || "";
          }

          // Update modal title and button
          document.getElementById(
            "addSoalModalLabel"
          ).textContent = `Edit Soal - ${getCategoryName(soal.kategori)}`;
          document.querySelector(
            "#addSoalModal .modal-footer .btn-primary"
          ).textContent = "Update Soal";
          document.querySelector(
            "#addSoalModal .modal-footer .btn-primary"
          ).onclick = () => updateSoal(id);

          $("#addSoalModal").modal("show");
        } catch (error) {
          console.error("Error editing soal:", error);
          showAlert("Gagal memuat data soal!", "error");
        }
      }

      // Update soal
      async function updateSoal(id) {
        const category = document.getElementById("soalCategory").value;
        const soalText = document.getElementById("soalText").value;
        const soalType = document.getElementById("soalType").value;
        const explanation = document.getElementById("soalExplanation").value;

        if (!soalText || !soalType) {
          showAlert("Pertanyaan dan tipe soal harus diisi!", "error");
          return;
        }

        let correctAnswer = "";
        let options = {};

        // Get correct answer based on soal type
        if (soalType === "pilihan_ganda") {
          const selectedAnswer = document.querySelector(
            'input[name="correctAnswer"]:checked'
          );
          if (!selectedAnswer) {
            showAlert("Pilih jawaban yang benar!", "error");
            return;
          }
          correctAnswer = selectedAnswer.value;

          // Get all options
          options = {
            A: document.getElementById("optionA").value,
            B: document.getElementById("optionB").value,
            C: document.getElementById("optionC").value,
            D: document.getElementById("optionD").value,
          };

          // Validate that all options are filled
          if (!options.A || !options.B || !options.C || !options.D) {
            showAlert("Semua pilihan jawaban harus diisi!", "error");
            return;
          }
        } else if (soalType === "essay") {
          correctAnswer = document.getElementById("correctEssayAnswer").value;
          if (!correctAnswer) {
            showAlert("Masukkan jawaban yang benar!", "error");
            return;
          }
        }

        try {
          const updateData = {
            category: category,
            question: soalText,
            type: soalType,
            correct_answer: correctAnswer,
            options: options,
            explanation: explanation,
            updated_at: new Date().toISOString(),
          };

          // Update in database
          await db.updateSoal(id, updateData);

          $("#addSoalModal").modal("hide");
          showAlert("Soal berhasil diperbarui!", "success");

          // Reset form and button
          document.getElementById("addSoalForm").reset();
          document.getElementById("pilihanGandaOptions").style.display = "none";
          document.getElementById("essayOptions").style.display = "none";
          document.getElementById("addSoalModalLabel").textContent =
            "Tambah Soal Baru";
          document.querySelector(
            "#addSoalModal .modal-footer .btn-primary"
          ).textContent = "Simpan Soal";
          document.querySelector(
            "#addSoalModal .modal-footer .btn-primary"
          ).onclick = saveSoal;

          // Reload soal list
          loadSoalList(category);
          updateStats(); // Update dashboard stats
        } catch (error) {
          console.error("Error updating soal:", error);
          showAlert("Gagal memperbarui soal: " + error.message, "error");
        }
      }

      // Delete soal
      async function deleteSoal(id, category) {
        if (confirm("Apakah Anda yakin ingin menghapus soal ini?")) {
          try {
            await db.deleteSoal(id);
            showAlert("Soal berhasil dihapus!", "success");
            loadSoalList(category);
            updateStats(); // Update dashboard stats
          } catch (error) {
            console.error("Error deleting soal:", error);
            showAlert("Gagal menghapus soal: " + error.message, "error");
          }
        }
      }

      // Initialize authentication and admin interface
      document.addEventListener("DOMContentLoaded", async function () {
        // Initialize Supabase first
        supabase = await initializeSupabase();
        
        if (!supabase) {
          console.error('Failed to initialize Supabase');
          showLoginAlert('Gagal menginisialisasi database. Silakan refresh halaman.');
          return;
        }

        // Check authentication status
        const isAuthenticated = await checkAuthStatus();
        
        if (!isAuthenticated) {
          showLoginForm();
        } else {
          initializeAdminInterface();
        }

        // Add login form event listener
        const loginForm = document.getElementById('loginForm');
        if (loginForm) {
          loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            handleLogin(email, password);
          });
        }

        // Add logout button event listener
        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
          logoutButton.addEventListener('click', function(e) {
            e.preventDefault();
            handleLogout();
          });
        }

        // Add event listener for latihan tab changes
        const latihanTabs = document.querySelectorAll("#latihanTabs .nav-link");
        latihanTabs.forEach((tab) => {
          tab.addEventListener("click", function (e) {
            const target = this.getAttribute("href");
            const category = target.replace("#", "").replace("-content", "");

            // Load soal list for the selected category only if database is ready
            setTimeout(() => {
              if (db) {
                loadSoalList(category);
              }
            }, 100);
          });
        });

        // Load soal list for harian by default only if database is ready
        setTimeout(() => {
          if (db) {
            loadSoalList("harian");
          }
        }, 100);
      });
    </script>

    <!-- Close wrapper and admin interface divs -->
    </div>
    </div>
  </body>
</html>
